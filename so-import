#!/usr/bin/env python

import xml.parsers.expat
import pymongo

from pymongo import MongoClient

connection = MongoClient()

# Each of our data files which will be used as collection names also.
files = [ "badges", "comments", "posts", "users", "votes" ]

# Name our database, can change this for Server Fault/etc..
db = connection['stackoverflow']

for file in files:

  print "init import: %s.xml" % file
  collection = db[file]

  def start_element(name, attrs):
    # Use SO entry id instead of autogenerated mongo one
    if u'Id' in attrs:
      attrs['_id'] = attrs[u'Id']
      del attrs[u'Id']

    # Attributes are all ready dict's of the right format, how convenient!
    collection.insert( attrs )

  parser = xml.parsers.expat.ParserCreate()
  parser.StartElementHandler = start_element
  parser.ParseFile( open( file + ".xml", "r") )

  print "imported %s %s" % ( collection.count() , files )
  print "finished import: %s.xml" % file

